# å·¥ä½œæµåç§°ï¼Œåœ¨ GitHub Actions é¡µé¢ä¸­æ˜¾ç¤º
name: immortalwrt openwrt make package

# è§¦å‘æ¡ä»¶
on:
  workflow_dispatch:        # å…è®¸åœ¨ GitHub ç•Œé¢æ‰‹åŠ¨è§¦å‘
    inputs:
      PACKAGE:
        description: 'è¦ç¼–è¯‘çš„è½¯ä»¶åŒ…åç§°ï¼ˆå¦‚ luci-app-openclashï¼‰ï¼Œå¤šä¸ªè½¯ä»¶åŒ…è¯·ç”¨é€—å·éš”å¼€ã€‚'
        required: true
        type: string

  # schedule:               # å®šæ—¶è‡ªåŠ¨æ„å»ºï¼ˆå½“å‰å·²æ³¨é‡Šï¼Œä¸å¯ç”¨ï¼‰
  #   - cron: 0 20 * * *    # æ¯å¤© UTC æ—¶é—´ 20:00 æ‰§è¡Œï¼ˆå³åŒ—äº¬æ—¶é—´æ¬¡æ—¥ 04:00ï¼‰
  
# å…¨å±€ç¯å¢ƒå˜é‡ï¼ˆæ‰€æœ‰ Job å‡å¯ä½¿ç”¨ï¼‰
env:
  SOURCE_URL: https://github.com/bhrq12/immortalwrt.git     # OpenWrt æºç ä»“åº“åœ°å€ï¼ˆImmortalWrtï¼‰
  SOURCE_BRANCH: main                                       # ä½¿ç”¨çš„æºç åˆ†æ”¯
  CONFIG_FILE: configs/config-ap8220.config                 # è‡ªå®šä¹‰è®¾å¤‡é…ç½®æ–‡ä»¶è·¯å¾„
  DIY_SCRIPT: diy-script-1.sh                               # è‡ªå®šä¹‰è„šæœ¬ï¼ˆç”¨äºæ·»åŠ æ’ä»¶ã€ä¿®æ”¹é»˜è®¤è®¾ç½®ç­‰ï¼‰
  TOOLCHAIN_TAG: Toolchain                                  # å·¥å…·é“¾ç¼“å­˜æ‰€ç”¨çš„ Release æ ‡ç­¾
  CLASH_KERNEL: arm64                                       # Clash å†…æ ¸æ¶æ„ï¼ˆç”¨äºé¢„ç½®ï¼‰
  UPLOAD_BIN_DIR: false                                     # æ˜¯å¦ä¸Šä¼ æ•´ä¸ª bin ç›®å½•ï¼ˆè°ƒè¯•ç”¨ï¼Œé€šå¸¸è®¾ä¸º falseï¼‰
  FIRMWARE_RELEASE: true                                    # æ˜¯å¦å°†æœ€ç»ˆå›ºä»¶å‘å¸ƒåˆ° GitHub Release
  FIRMWARE_TAG: ROOTFS_PLUS                                 # å›ºä»¶å‘å¸ƒçš„ Release æ ‡ç­¾å
  OPENWRT_RELEASE: true                                     # ï¼ˆä¿ç•™å­—æ®µï¼Œå½“å‰æœªå®é™…ä½¿ç”¨ï¼‰
  OPENWRT_TAG: AP8220_128m_PLUS_immortalwrt                 # ï¼ˆä¿ç•™å­—æ®µï¼‰
  WRT_PACKAGE: ${{ github.event.inputs.PACKAGE }}
  TZ: Asia/Shanghai                                         # è®¾ç½®æ—¶åŒºä¸ºä¸Šæµ·

# å®šä¹‰ä¸¤ä¸ª Jobï¼šå…ˆæ„å»ºå·¥å…·é“¾ï¼ˆToolchainï¼‰ï¼Œå†æ„å»ºå›ºä»¶ï¼ˆBuildï¼‰
jobs:

  # =============== ç¬¬ä¸€é˜¶æ®µï¼šæ„å»ºå¹¶ç¼“å­˜äº¤å‰ç¼–è¯‘å·¥å…·é“¾ ===============
  Toolchain:
    runs-on: ubuntu-22.04  # ä½¿ç”¨ Ubuntu 22.04 è™šæ‹Ÿæœº

    # å®šä¹‰è¾“å‡ºå˜é‡ï¼Œä¾›åç»­ Build Job ä½¿ç”¨
    outputs:
      OPENWRT_PATH: ${{ steps.clone.outputs.OPENWRT_PATH }}
      VERSION_INFO: ${{ steps.clone.outputs.VERSION_INFO }}
      CURRENT_BRANCH: ${{ steps.env.outputs.CURRENT_BRANCH }}
      SOURCE_REPO: ${{ steps.env.outputs.SOURCE_REPO }}
      DEVICE_TARGET: ${{ steps.env.outputs.DEVICE_TARGET }}
      DEVICE_SUBTARGET: ${{ steps.env.outputs.DEVICE_SUBTARGET }}
      TOOLCHAIN_IMAGE: ${{ steps.env.outputs.TOOLCHAIN_IMAGE }}

    steps:
    # 1. æ£€å‡ºå½“å‰ä»“åº“ä»£ç ï¼ˆç”¨äºè·å– configs/ å’Œ diy-script.sh ç­‰æœ¬åœ°æ–‡ä»¶ï¼‰
    - name: Checkout
      uses: actions/checkout@main

    # 2. åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒï¼šæ¸…ç†æ— ç”¨è½¯ä»¶åŒ…ï¼Œå®‰è£…ä¾èµ–
    - name: Initialization Environment
      env:
        DEBIAN_FRONTEND: noninteractive  # é¿å… apt å®‰è£…æ—¶å¼¹å‡ºäº¤äº’å¼é…ç½®
      run: |
        # æ¸…ç†ç³»ç»Ÿå†—ä½™ç»„ä»¶ï¼ˆèŠ‚çœç©ºé—´ã€é¿å…å†²çªï¼‰
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /etc/mysql /etc/php /usr/local/lib/android
        # æ›´æ–°è½¯ä»¶æºå¹¶å®‰è£… OpenWrt ç¼–è¯‘æ‰€éœ€ä¾èµ–ï¼ˆé€šè¿‡çŸ­é“¾æ¥åŠ¨æ€è·å–ï¼‰
        sudo -E apt-get -qq update
        sudo -E apt-get -y install $(curl -fsSL is.gd/depends_ubuntu_2204)
        # æ¸…ç†æ— ç”¨åŒ…å’Œç¼“å­˜
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        # è®¾ç½®æ—¶åŒº
        sudo timedatectl set-timezone "$TZ"

    # 3. å…‹éš† OpenWrt æºç ï¼Œå¹¶è®°å½•ç‰ˆæœ¬ä¿¡æ¯
    - name: Clone Source Code
      id: clone
      run: |
        df -hT $GITHUB_WORKSPACE  # æ˜¾ç¤ºåˆå§‹ç£ç›˜ä½¿ç”¨æƒ…å†µ
        git clone $SOURCE_URL -b $SOURCE_BRANCH workspace/openwrt
        cd workspace/openwrt
        echo "OPENWRT_PATH=$PWD" >> $GITHUB_ENV
        echo "OPENWRT_PATH=$(echo $PWD)" >> $GITHUB_OUTPUT
        # è·å–æœ€åä¸€æ¬¡æäº¤çš„ç®€è¦ä¿¡æ¯ï¼ˆç”¨äº Release æè¿°ï¼‰
        export VERSION_INFO=$(git show -s --date=short --format="Author: %an<br/>date: %cd<br/>commit: %s<br/>commit hash: %H")
        echo "VERSION_INFO=$VERSION_INFO" >> $GITHUB_ENV
        echo "VERSION_INFO=$(echo $VERSION_INFO)" >> $GITHUB_OUTPUT

    # 4. ç”Ÿæˆå·¥å…·é“¾ä¸“ç”¨é…ç½®æ–‡ä»¶
    - name: Generate Toolchain Config
      run: |
        # å¦‚æœå­˜åœ¨è‡ªå®šä¹‰é…ç½®æ–‡ä»¶ï¼Œåˆ™ç§»åŠ¨åˆ°æºç ç›®å½•ä½œä¸º .config
        [ -e $CONFIG_FILE ] && mv $CONFIG_FILE $OPENWRT_PATH/.config
        # å¼ºåˆ¶å¯ç”¨æ‰€æœ‰å·¥å…·é“¾ç›¸å…³é€‰é¡¹ï¼Œç¡®ä¿å·¥å…·é“¾å®Œæ•´
        echo "CONFIG_ALL=y" >> $OPENWRT_PATH/.config
        echo "CONFIG_ALL_NONSHARED=y" >> $OPENWRT_PATH/.config
        cd $OPENWRT_PATH
        make defconfig > /dev/null 2>&1  # ç”Ÿæˆæ ‡å‡†é…ç½®

    # 5. ä»é…ç½®ä¸­æå–å…³é”®å˜é‡ï¼ˆå¹³å°ã€å­å¹³å°ç­‰ï¼‰
    - name: Generate Variables
      id: env
      run: |
        export CURRENT_BRANCH="$(git symbolic-ref --short HEAD)"
        echo "CURRENT_BRANCH=$CURRENT_BRANCH" >> $GITHUB_ENV
        echo "CURRENT_BRANCH=$(echo $CURRENT_BRANCH)" >> $GITHUB_OUTPUT
        cd $OPENWRT_PATH
        # ä» SOURCE_URL æå–ä»“åº“åï¼ˆå¦‚ immortalwrtï¼‰
        export SOURCE_REPO="$(echo $SOURCE_URL | awk -F '/' '{print $(NF)}' | sed 's/\.git$//')"
        echo "SOURCE_REPO=$SOURCE_REPO" >> $GITHUB_ENV
        echo "SOURCE_REPO=$(echo $SOURCE_REPO)" >> $GITHUB_OUTPUT
        # ä» .config ä¸­æå–ç›®æ ‡å¹³å°ï¼ˆå¦‚ ipq807xï¼‰
        export DEVICE_TARGET=$(cat .config | grep CONFIG_TARGET_BOARD | awk -F '"' '{print $2}')
        echo "DEVICE_TARGET=$DEVICE_TARGET" >> $GITHUB_ENV
        echo "DEVICE_TARGET=$(echo $DEVICE_TARGET)" >> $GITHUB_OUTPUT
        # æå–å­å¹³å°ï¼ˆå¦‚ genericï¼‰
        export DEVICE_SUBTARGET=$(cat .config | grep CONFIG_TARGET_SUBTARGET | awk -F '"' '{print $2}')
        echo "DEVICE_SUBTARGET=$DEVICE_SUBTARGET" >> $GITHUB_ENV
        echo "DEVICE_SUBTARGET=$(echo $DEVICE_SUBTARGET)" >> $GITHUB_OUTPUT
        # ç”Ÿæˆå·¥å…·é“¾é•œåƒå”¯ä¸€åç§°
        export TOOLCHAIN_IMAGE="toolchain-$SOURCE_REPO-$SOURCE_BRANCH-$DEVICE_TARGET-$DEVICE_SUBTARGET"
        echo "TOOLCHAIN_IMAGE=$TOOLCHAIN_IMAGE" >> $GITHUB_ENV
        echo "TOOLCHAIN_IMAGE=$(echo $TOOLCHAIN_IMAGE)" >> $GITHUB_OUTPUT

    # 6. æ¯”è¾ƒå·¥å…·é“¾å“ˆå¸Œå€¼ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦é‡å»º
    - name: Compare Toolchain Hash
      id: hash
      run: |
        cd $OPENWRT_PATH
        # è·å– tools/ å’Œ toolchain/ ç›®å½•çš„æœ€æ–°æäº¤å“ˆå¸Œ
        export CURRENT_HASH=$(git log --pretty=tformat:"%H" -n1 tools toolchain)
        echo "CURRENT_HASH=$CURRENT_HASH" >> $GITHUB_ENV
        echo "CURRENT_HASH is $CURRENT_HASH"
        # å°è¯•ä» Release ä¸‹è½½å·²ç¼“å­˜çš„å“ˆå¸Œå€¼
        export CACHE_HASH=$(curl -fSsL https://github.com/$GITHUB_REPOSITORY/releases/download/$TOOLCHAIN_TAG/$TOOLCHAIN_IMAGE.hash 2>/dev/null || echo "")
        echo "CACHE_HASH is $CACHE_HASH"
        # è‹¥ç¼“å­˜ä¸å­˜åœ¨æˆ–å“ˆå¸Œä¸åŒ¹é…ï¼Œåˆ™æ ‡è®°éœ€è¦é‡å»º
        if [ -z "$CACHE_HASH" ] || [ "$CURRENT_HASH" != "$CACHE_HASH" ]; then
          echo "REBUILD_TOOLCHAIN=true" >> $GITHUB_OUTPUT
        fi

    # 7. å®‰è£… feedsï¼ˆä»…åœ¨éœ€è¦é‡å»ºå·¥å…·é“¾æ—¶æ‰§è¡Œï¼‰
    - name: Install Feeds
      if: steps.hash.outputs.REBUILD_TOOLCHAIN == 'true'
      run: |
        cd $OPENWRT_PATH
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    # 8. ç¼–è¯‘å®¿ä¸»å·¥å…·ï¼ˆå¦‚ mkimage, patch ç­‰ï¼‰
    - name: Compile Tools
      if: steps.hash.outputs.REBUILD_TOOLCHAIN == 'true'
      run: |
        cd $OPENWRT_PATH
        make defconfig
        echo -e "$(nproc) thread compile"
        make tools/compile -j$(nproc) || make tools/compile -j1 V=s

    # 9. ç¼–è¯‘äº¤å‰ç¼–è¯‘å·¥å…·é“¾ï¼ˆå¦‚ gcc-armï¼‰
    - name: Compile Toolchain
      if: steps.hash.outputs.REBUILD_TOOLCHAIN == 'true'
      run: |
        cd $OPENWRT_PATH
        echo -e "$(nproc) thread compile"
        make toolchain/compile -j$(nproc) || make toolchain/compile -j1 V=s
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶ï¼Œå‡å°é•œåƒä½“ç§¯
        rm -rf .config* dl bin

    # 10. å°†æ•´ä¸ª openwrt ç›®å½•æ‰“åŒ…ä¸º SquashFS é•œåƒï¼ˆåªè¯»å‹ç¼©ï¼‰
    - name: Generate Toolchain Image
      if: steps.hash.outputs.REBUILD_TOOLCHAIN == 'true'
      run: |
        cd workspace
        # ä½¿ç”¨ zstd å‹ç¼©ï¼ŒæŒ‡å®š UID/GID ä¿è¯æƒé™ä¸€è‡´
        mksquashfs openwrt $TOOLCHAIN_IMAGE -force-gid 1001 -force-uid 1001 -comp zstd
        mkdir -p $GITHUB_WORKSPACE/output
        # åˆ†å·ï¼ˆGitHub å•æ–‡ä»¶é™åˆ¶çº¦ 2GBï¼‰
        split -d -b 1900M $TOOLCHAIN_IMAGE $GITHUB_WORKSPACE/output/$TOOLCHAIN_IMAGE.img.
        rm $TOOLCHAIN_IMAGE
        # ä¿å­˜å½“å‰å“ˆå¸Œï¼Œç”¨äºä¸‹æ¬¡æ¯”å¯¹
        echo $CURRENT_HASH > $GITHUB_WORKSPACE/output/$TOOLCHAIN_IMAGE.hash
        ls -lh $GITHUB_WORKSPACE/output

    # 11. åˆ é™¤æ—§çš„å·¥å…·é“¾ç¼“å­˜æ–‡ä»¶ï¼ˆé¿å…å †ç§¯ï¼‰
    - name: Delete Old Toolchain Assets
      if: steps.hash.outputs.REBUILD_TOOLCHAIN == 'true'
      uses: mknejp/delete-release-assets@v1
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        tag: ${{ env.TOOLCHAIN_TAG }}
        assets: '${{ env.TOOLCHAIN_IMAGE }}.*'
        fail-if-no-assets: false
        fail-if-no-release: false

    # 12. ä¸Šä¼ æ–°çš„å·¥å…·é“¾é•œåƒåˆ° Release
    - name: Upload Toolchain Image
      if: steps.hash.outputs.REBUILD_TOOLCHAIN == 'true'
      uses: ncipollo/release-action@v1
      with:
        name: Toolchain-Image
        allowUpdates: true
        tag: ${{ env.TOOLCHAIN_TAG }}
        token: ${{ secrets.GITHUB_TOKEN }}
        artifacts: output/*
        body: OpenWrt å·¥å…·é“¾é•œåƒæ–‡ä»¶ï¼ˆç”¨äºåŠ é€Ÿåç»­æ„å»ºï¼‰

  # =============== ç¬¬äºŒé˜¶æ®µï¼šä½¿ç”¨ç¼“å­˜å·¥å…·é“¾æ„å»ºå›ºä»¶ ===============
  Build:
    needs: [Toolchain]  # å¿…é¡»ç­‰å¾… Toolchain Job æˆåŠŸå®Œæˆ
    runs-on: ubuntu-22.04

    # ä» Toolchain Job ç»§æ‰¿å…³é”®å˜é‡
    env:
      OPENWRT_PATH: ${{ needs.Toolchain.outputs.OPENWRT_PATH }}
      VERSION_INFO: ${{ needs.Toolchain.outputs.VERSION_INFO }}
      CURRENT_BRANCH: ${{ needs.Toolchain.outputs.CURRENT_BRANCH }}
      SOURCE_REPO: ${{ needs.Toolchain.outputs.SOURCE_REPO }}
      DEVICE_TARGET: ${{ needs.Toolchain.outputs.DEVICE_TARGET }}
      DEVICE_SUBTARGET: ${{ needs.Toolchain.outputs.DEVICE_SUBTARGET }}
      TOOLCHAIN_IMAGE: ${{ needs.Toolchain.outputs.TOOLCHAIN_IMAGE }}
      PACKAGE_INPUT: ${{ github.event.inputs.PACKAGE }}

    steps:
    
    # ğŸ‘‡ã€æ–°å¢ã€‘ç¬¬ä¸€æ­¥ï¼šéªŒè¯ PACKAGE æ˜¯å¦ä¸ºç©º
    - name: Validate PACKAGE input
      run: |
        PKGS_INPUT="$PACKAGE_INPUT"
        if [ -z "$PKGS_INPUT" ]; then
          echo "âŒ é”™è¯¯ï¼šPACKAGE å‚æ•°ä¸èƒ½ä¸ºç©ºï¼"
          echo "è¯·åœ¨æ‰‹åŠ¨è§¦å‘æ—¶å¡«å†™è¦ç¼–è¯‘çš„è½¯ä»¶åŒ…åç§°ï¼ˆä¾‹å¦‚ï¼šluci-app-openclashï¼‰"
          echo "å¤šä¸ªåŒ…è¯·ç”¨é€—å·åˆ†éš”ï¼Œå¦‚ï¼šluci-app-openclash,luci-theme-argon"
          exit 1
        fi
        echo "âœ… å°†ç¼–è¯‘è½¯ä»¶åŒ…: $PKGS_INPUT"
    
    # 1. æ˜¾ç¤ºæœåŠ¡å™¨ç¡¬ä»¶ä¿¡æ¯ï¼ˆæé†’ç”¨æˆ·æ³¨æ„èµ„æºé™åˆ¶ï¼‰
    - name: Check Server Performance
      run: |
        echo "è­¦å‘Šâš "
        echo "åˆ†é…çš„æœåŠ¡å™¨æ€§èƒ½æœ‰é™ï¼Œè‹¥é€‰æ‹©çš„æ’ä»¶è¿‡å¤šï¼ŒåŠ¡å¿…æ³¨æ„CPUæ€§èƒ½ï¼"
        echo -e "å·²çŸ¥CPUå‹å·ï¼ˆé™åºï¼‰ï¼š8370Cï¼Œ8272CLï¼Œ8171Mï¼ŒE5-2673 \n"
        echo "--------------------------CPUä¿¡æ¯--------------------------"
        echo "CPUç‰©ç†æ•°é‡ï¼š$(cat /proc/cpuinfo | grep "physical id" | sort | uniq | wc -l)"
        echo -e "CPUæ ¸å¿ƒä¿¡æ¯ï¼š$(cat /proc/cpuinfo | grep name | cut -f2 -d: | uniq -c) \n"
        echo "--------------------------å†…å­˜ä¿¡æ¯--------------------------"
        echo "å·²å®‰è£…å†…å­˜è¯¦ç»†ä¿¡æ¯ï¼š"
        echo -e "$(sudo lshw -short -C memory | grep GiB) \n"
        echo "--------------------------ç¡¬ç›˜ä¿¡æ¯--------------------------"
        echo "ç¡¬ç›˜æ•°é‡ï¼š$(ls /dev/sd* | grep -v [1-9] | wc -l)" && df -hT

    # 2. æ›´å½»åº•åœ°åˆå§‹åŒ–ç¯å¢ƒï¼ˆä¸º OverlayFS å’Œ Btrfs åšå‡†å¤‡ï¼‰
    - name: Initialization Environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        docker rmi $(docker images -q)  # æ¸…é™¤ Docker é•œåƒ
        # å½»åº•å¸è½½å¤§å‹æ— ç”¨è½¯ä»¶ï¼ˆAzure CLIã€Javaã€PHPã€MySQL ç­‰ï¼‰
        sudo -E apt-get -y purge azure-cli* docker* ghc* zulu* llvm* firefox* google* dotnet* powershell* openjdk* mysql* php* mongodb* moby* snap* aspnetcore*
        sudo -E apt-get -qq update
        # å®‰è£… Btrfs å’Œ FUSE æ”¯æŒï¼ˆç”¨äºåˆå¹¶ç£ç›˜ï¼‰
        sudo -E apt-get -y install libfuse-dev $(curl -fsSL is.gd/depends_ubuntu_2204)
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"

    # 3. åˆå¹¶æ ¹åˆ†åŒºä¸ /mnt åˆ†åŒºï¼Œæ‰©å±•å¯ç”¨ç£ç›˜ç©ºé—´ï¼ˆçªç ´ ~14GB é™åˆ¶ï¼‰
    - name: Combine Disks
      run: |
        sudo swapoff -a && sudo rm -f /mnt/swapfile
        # åˆ›å»º loop è®¾å¤‡æ‰©å±•æ ¹åˆ†åŒº
        export ROOT_FREE_KB=$(df --block-size=1024 --output=avail / | tail -1)
        export ROOT_LOOP_KB=$(expr $ROOT_FREE_KB - 1048576)  # ä¿ç•™ 1GB
        export ROOT_LOOP_BYTES=$(expr $ROOT_LOOP_KB \* 1024)
        sudo fallocate -l $ROOT_LOOP_BYTES /root.img
        export ROOT_LOOP_DEVNAME=$(sudo losetup -Pf --show /root.img)
        sudo pvcreate -f $ROOT_LOOP_DEVNAME
        # åŒæ ·å¤„ç† /mnt
        export MNT_FREE_KB=$(df --block-size=1024 --output=avail /mnt | tail -1)
        export MNT_LOOP_KB=$(expr $MNT_FREE_KB - 102400)
        export MNT_LOOP_BYTES=$(expr $MNT_LOOP_KB \* 1024)
        sudo fallocate -l $MNT_LOOP_BYTES /mnt/mnt.img
        export MNT_LOOP_DEVNAME=$(sudo losetup -Pf --show /mnt/mnt.img)
        sudo pvcreate -f $MNT_LOOP_DEVNAME
        # åˆå¹¶ä¸º LVM å·ç»„
        sudo vgcreate vgstorage $ROOT_LOOP_DEVNAME $MNT_LOOP_DEVNAME
        sudo lvcreate -n lvstorage -l 100%FREE vgstorage
        export LV_DEVNAME=$(sudo lvscan | awk -F "'" '{print $2}')
        # æ ¼å¼åŒ–ä¸º Btrfs å¹¶æŒ‚è½½åˆ°å·¥ä½œç›®å½•
        sudo mkfs.btrfs -L combinedisk $LV_DEVNAME
        sudo mount -o compress=zstd $LV_DEVNAME $GITHUB_WORKSPACE
        sudo chown -R runner:runner $GITHUB_WORKSPACE
        mkdir $GITHUB_WORKSPACE/tmp && chmod 777 $GITHUB_WORKSPACE/tmp
        sudo cp -rp /tmp/* $GITHUB_WORKSPACE/tmp
        sudo mount -B $GITHUB_WORKSPACE/tmp /tmp && df -hT

    # 4. é‡æ–°æ£€å‡ºå½“å‰åˆ†æ”¯ä»£ç ï¼ˆç¡®ä¿æœ¬åœ°è„šæœ¬æœ€æ–°ï¼‰
    - name: Checkout
      run: |
        cd $GITHUB_WORKSPACE
        git init
        git remote add origin https://github.com/$GITHUB_REPOSITORY
        git fetch
        git checkout -t origin/$CURRENT_BRANCH

    # 5. ä¸‹è½½å¹¶æŒ‚è½½ç¼“å­˜çš„å·¥å…·é“¾é•œåƒï¼ˆä½¿ç”¨ OverlayFS å®ç°å¯å†™å±‚ï¼‰
    - name: Prepare Toolchain Image
      run: |
        mkdir -p workspace
        cd workspace
        # åˆå¹¶åˆ†å·æ–‡ä»¶
        for i in {0..9}
        do
          curl -fsL https://github.com/$GITHUB_REPOSITORY/releases/download/$TOOLCHAIN_TAG/$TOOLCHAIN_IMAGE.img.0$i >> $TOOLCHAIN_IMAGE.img || break
        done
        mkdir openwrt-ro openwrt workdir overlay
        # åªè¯»æŒ‚è½½å·¥å…·é“¾é•œåƒ
        sudo mount -o loop $TOOLCHAIN_IMAGE.img openwrt-ro
        # ä½¿ç”¨ OverlayFS åˆ›å»ºå¯å†™å±‚ï¼ˆåº•å±‚åªè¯»ï¼Œä¸Šå±‚å¯å†™ï¼‰
        sudo mount -t overlay overlay -o lowerdir=openwrt-ro,upperdir=overlay,workdir=workdir openwrt
        cd $OPENWRT_PATH
        git pull  # æ›´æ–°æºç ï¼ˆä½†å·¥å…·é“¾ä¿æŒä¸å˜ï¼‰

    # 6. å®‰è£… feedsï¼ˆå› æºç å¯èƒ½æ›´æ–°ï¼‰
    - name: Install Feeds
      run: |
        cd $OPENWRT_PATH
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    # 7. åº”ç”¨è‡ªå®šä¹‰é…ç½®å’Œè„šæœ¬
    - name: Load Custom Configuration
      run: |
        # å¤åˆ¶è‡ªå®šä¹‰æ–‡ä»¶ï¼ˆå¦‚ bannerã€é»˜è®¤é…ç½®ç­‰ï¼‰
        [ -e files ] && mv files $OPENWRT_PATH/files
        # åŠ è½½è®¾å¤‡é…ç½®
        [ -e $CONFIG_FILE ] && mv $CONFIG_FILE $OPENWRT_PATH/.config
        # èµ‹äºˆè„šæœ¬æ‰§è¡Œæƒé™
        chmod +x $GITHUB_WORKSPACE/scripts/*.sh
        chmod +x $DIY_SCRIPT
        cd $OPENWRT_PATH
        # æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬ï¼ˆæ ¸å¿ƒå®šåˆ¶æ­¥éª¤ï¼‰
        $GITHUB_WORKSPACE/$DIY_SCRIPT
        # é¢„ç½® Clash å†…æ ¸å’Œç»ˆç«¯å·¥å…·
        $GITHUB_WORKSPACE/scripts/preset-clash-core.sh $CLASH_KERNEL
        $GITHUB_WORKSPACE/scripts/preset-terminal-tools.sh

    # 8. ä¸‹è½½æ‰€æœ‰ä¾èµ–æºç åŒ…ï¼ˆdl/ ç›®å½•ï¼‰
    - name: Download DL Package
      run: |
        cd $OPENWRT_PATH
        make defconfig
        make oldconfig
        make download -j8  # å¹¶è¡Œä¸‹è½½
        # æ¸…ç†ç©ºæ–‡ä»¶æˆ–æŸåæ–‡ä»¶
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;

    # 9. ç¼–è¯‘æŒ‡å®šçš„è½¯ä»¶åŒ…ï¼ˆæ”¯æŒé€—å·åˆ†éš”ï¼‰
    - name: Compile Specified Packages
      run: |
        cd "$OPENWRT_PATH"
        PKGS_INPUT="$PACKAGE_INPUT"

        # å®‰å…¨åˆ†å‰²å¹¶å»é‡ã€å»ç©ºæ ¼
        IFS=',' read -r -a PKG_ARRAY_RAW <<< "$PKGS_INPUT"
        declare -a VALID_PKGS=()
        for raw_pkg in "${PKG_ARRAY_RAW[@]}"; do
          # å»é™¤é¦–å°¾ç©ºæ ¼
          pkg=$(echo "$raw_pkg" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          # è·³è¿‡ç©ºå­—ç¬¦ä¸²
          if [ -n "$pkg" ]; then
            VALID_PKGS+=("$pkg")
          fi
        done

        # å»é‡ï¼ˆå¯é€‰ï¼Œé˜²æ­¢ç”¨æˆ·é‡å¤è¾“å…¥ï¼‰
        declare -A PKG_MAP
        for pkg in "${VALID_PKGS[@]}"; do
          PKG_MAP["$pkg"]=1
        done
        VALID_PKGS=("${!PKG_MAP[@]}")

        if [ ${#VALID_PKGS[@]} -eq 0 ]; then
          echo "âŒ æ— æœ‰æ•ˆè½¯ä»¶åŒ…å¯ç¼–è¯‘ï¼"
          exit 1
        fi

        echo "âœ… å°†ç¼–è¯‘ä»¥ä¸‹è½¯ä»¶åŒ…: ${VALID_PKGS[*]}"

        # é€ä¸ªç¼–è¯‘
        for pkg in "${VALID_PKGS[@]}"; do
          echo ""
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "ğŸ“¦ ç¼–è¯‘: $pkg"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          make "package/$pkg/compile" -j$(nproc) V=s || \
          make "package/$pkg/compile" -j1 V=s || {
            echo "âŒ ç¼–è¯‘å¤±è´¥: $pkg"
            exit 1
          }
        done

        # ç”Ÿæˆè½¯ä»¶åŒ…ç´¢å¼•
        make package/index
        
    # # 10. ç”Ÿæˆæœ€ç»ˆå›ºä»¶é•œåƒ
    # - name: Generate Firmware
    #   id: generate
    #   run: |
    #     cd $OPENWRT_PATH
    #     mkdir -p files/etc/uci-defaults
    #     # ï¼ˆå¯é€‰ï¼‰æ·»åŠ é¦–æ¬¡å¯åŠ¨è„šæœ¬
    #     # cp $GITHUB_WORKSPACE/scripts/init-settings.sh files/etc/uci-defaults/99-init-settings
    #     make package/install -j$(nproc) || make package/install -j1 V=s
    #     make target/install -j$(nproc) || make target/install -j1 V=s
    #     echo "status=success" >> $GITHUB_OUTPUT  # æ ‡è®°æˆåŠŸ
    #     make checksum  # ç”Ÿæˆ sha256sums
    #     echo "DATE=$(date +"%Y-%m-%d %H:%M:%S")" >> $GITHUB_ENV
    #     echo "FILE_DATE=$(date +"%Y.%m.%d")" >> $GITHUB_ENV

    # 11. æ£€æŸ¥æœ€ç»ˆç£ç›˜ä½¿ç”¨æƒ…å†µï¼ˆå³ä½¿å¤±è´¥ä¹Ÿè¿è¡Œï¼‰
    - name: Check Space Usage
      if: always()
      run: |
        lsblk -f
        echo -e "\n"
        df -hT
        echo -e "\n"
        sudo btrfs filesystem usage $GITHUB_WORKSPACE

    # 12. ï¼ˆå¯é€‰ï¼‰ä¸Šä¼ æ•´ä¸ª bin ç›®å½•åˆ° Artifactï¼ˆè°ƒè¯•ç”¨ï¼‰
    - name: Upload Bin Directory
      if: steps.generate.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true'
      uses: actions/upload-artifact@main
      with:
        name: ${{ env.SOURCE_REPO }}-bin-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}-${{ env.FILE_DATE }}
        path: ${{ env.OPENWRT_PATH }}/bin
    
    # 13. æ‰“åŒ…ç”Ÿæˆçš„ .ipk è½¯ä»¶åŒ…
    - name: Package Compiled IPKs
      if: steps.generate.outputs.status == 'success'
      run: |
        cd "$OPENWRT_PATH"
        
        # æŸ¥æ‰¾æ‰€æœ‰ .ipk æ–‡ä»¶æ‰€åœ¨çš„ feeds ç›®å½•ï¼ˆé€šå¸¸åªæœ‰ä¸€ä¸ªæ¶æ„ï¼‰
        PKG_BASE="bin/packages"
        if [ ! -d "$PKG_BASE" ]; then
          echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ° bin/packages ç›®å½•ï¼Œå¯èƒ½ç¼–è¯‘æœªç”Ÿæˆä»»ä½• .ipk"
          ls -la bin/
          exit 1
        fi
    
        # åˆ›å»ºè¾“å‡ºç›®å½•
        OUTPUT_DIR="$GITHUB_WORKSPACE/ipk_output"
        mkdir -p "$OUTPUT_DIR"
    
        # å¤åˆ¶æ‰€æœ‰ .ipk å’Œ Packages* ç´¢å¼•æ–‡ä»¶
        find "$PKG_BASE" -name "*.ipk" -exec cp {} "$OUTPUT_DIR/" \;
        find "$PKG_BASE" -name "Packages*" -exec cp {} "$OUTPUT_DIR/" \;
    
        # å¯é€‰ï¼šä¿ç•™ build.configï¼ˆè®°å½•é…ç½®ï¼‰
        cp .config "$OUTPUT_DIR/build.config" 2>/dev/null || true
    
        # æ‰“åŒ…
        tar -zcf "$OUTPUT_DIR/Packages.tar.gz" -C "$OUTPUT_DIR" .
    
        echo "FIRMWARE_PATH=$OUTPUT_DIR" >> $GITHUB_ENV
        echo "âœ… å·²æ‰“åŒ… $(ls $OUTPUT_DIR/*.ipk | wc -l) ä¸ª .ipk æ–‡ä»¶"
        
    # 14. è‹¥ä¸å‘å¸ƒ Releaseï¼Œåˆ™ä¸Šä¼ åˆ°ä¸´æ—¶ Artifact
    - name: Upload Firmware To Artifact
      if: steps.generate.outputs.status == 'success' && env.FIRMWARE_RELEASE != 'true'
      uses: actions/upload-artifact@main
      with:
        name: ${{ env.SOURCE_REPO }}-firmware-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}-${{ env.FILE_DATE }}
        path: ${{ env.FIRMWARE_PATH }}

    # 15. å‘å¸ƒå›ºä»¶åˆ° GitHub Release
    - name: Upload Firmware To Release
      if: steps.generate.outputs.status == 'success' && env.FIRMWARE_RELEASE == 'true'
      uses: ncipollo/release-action@v1
      with:
        name: R${{ env.DATE }} for ${{ env.FIRMWARE_TAG }}
        allowUpdates: true
        tag: ${{ env.FIRMWARE_TAG }}
        token: ${{ secrets.GITHUB_TOKEN }}
        artifacts: ${{ env.FIRMWARE_PATH }}/*
        body: |
          **è¿™æ˜¯ ipq8071-ap8220-128m å¤šåŠŸèƒ½ç‰ˆå›ºä»¶**
          ç›´åˆ·å›ºä»¶å‚è§ Tag åä¸º ipq8071-ap8220-128m çš„ Releases
          å½“å‰ä½¿ç”¨ç‰ˆæœ¬:ã€ç¼–è¯‘å‰çš„æœ€åä¸€æ¬¡[â¦ä¸»æºç ](https://github.com/bhrq12/immortalwrt.git)æ›´æ–°è®°å½•ã€‘
          ${{ env.VERSION_INFO }}
